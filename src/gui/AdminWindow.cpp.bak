#include "AdminWindow.hpp"
#include "../db/Database.hpp"
#include "../utils/Logger.hpp"

#include <QVBoxLayout>
#include <QHBoxLayout>
#include <QSqlQuery>
#include <QSqlError>
#include <QInputDialog>
#include <QMessageBox>
#include <QLabel>
#include <QHeaderView>
#include <QTableWidgetItem>
#include <QDebug>

AdminWindow::AdminWindow(int adminId, QWidget *parent)
    : QWidget(parent), m_adminId(adminId)
{
    setWindowTitle("Jumandgi — Администратор");
    resize(900,600);

    auto v = new QVBoxLayout(this);

    // Users table
    tblUsers = new QTableWidget(this);
    tblUsers->setColumnCount(4);
    tblUsers->setHorizontalHeaderLabels({"ID","Login","Full name","Role"});
    tblUsers->setSelectionBehavior(QAbstractItemView::SelectRows);
    tblUsers->horizontalHeader()->setStretchLastSection(true);
    v->addWidget(new QLabel("Пользователи:"));
    v->addWidget(tblUsers, 1);

    // Buttons row
    auto h = new QHBoxLayout();
    btnCreateUser = new QPushButton("Создать пользователя", this);
    btnEditUser = new QPushButton("Редактировать", this);
    btnToggleActive = new QPushButton("Актив/Деактив", this);
    btnDeleteUser = new QPushButton("Удалить пользователя", this);
    btnCreateDiscipline = new QPushButton("Создать дисциплину", this);
    btnCreateAssignment = new QPushButton("Создать задание", this);
    btnRefresh = new QPushButton("Обновить", this);

    h->addWidget(btnCreateUser);
    h->addWidget(btnEditUser);
    h->addWidget(btnToggleActive);
    h->addWidget(btnDeleteUser);
    h->addStretch();
    h->addWidget(btnCreateDiscipline);
    h->addWidget(btnCreateAssignment);
    h->addWidget(btnRefresh);

    v->addLayout(h);

    // Signals
    connect(btnCreateUser, &QPushButton::clicked, this, &AdminWindow::onCreateUser);
    connect(btnEditUser, &QPushButton::clicked, this, &AdminWindow::onEditUser);
    connect(btnToggleActive, &QPushButton::clicked, this, &AdminWindow::onToggleActive);
    connect(btnDeleteUser, &QPushButton::clicked, this, &AdminWindow::onDeleteUser);
    connect(btnCreateDiscipline, &QPushButton::clicked, this, &AdminWindow::onCreateDiscipline);
    connect(btnCreateAssignment, &QPushButton::clicked, this, &AdminWindow::onCreateAssignment);
    connect(btnRefresh, &QPushButton::clicked, this, &AdminWindow::onRefresh);

    // Initial load
    loadUsers();
}

void AdminWindow::showError(const QString &text) {
    QMessageBox::warning(this, "Ошибка", text);
}

void AdminWindow::loadUsers() {
    tblUsers->setRowCount(0);
    QSqlQuery q(Database::instance().get());
    if (!q.exec("SELECT id, login, full_name, role FROM users ORDER BY id")) {
        showError("Не удалось загрузить пользователей: " + q.lastError().text());
        return;
    }
    int r = 0;
    while (q.next()) {
        tblUsers->insertRow(r);
        tblUsers->setItem(r,0, new QTableWidgetItem(QString::number(q.value(0).toInt())));
        tblUsers->setItem(r,1, new QTableWidgetItem(q.value(1).toString()));
        tblUsers->setItem(r,2, new QTableWidgetItem(q.value(2).toString()));
        tblUsers->setItem(r,3, new QTableWidgetItem(q.value(3).toString()));
        r++;
    }
    tblUsers->resizeColumnsToContents();
}

void AdminWindow::onCreateUser() {
    bool ok;
    QString login = QInputDialog::getText(this, "Создать пользователя", "Login:", QLineEdit::Normal, "", &ok);
    if (!ok || login.trimmed().isEmpty()) return;
    QString role = QInputDialog::getText(this, "Создать пользователя", "Role (student/teacher/admin):", QLineEdit::Normal, "student", &ok);
    if (!ok || role.trimmed().isEmpty()) return;
    QString full = QInputDialog::getText(this, "Создать пользователя", "Full name:", QLineEdit::Normal, "", &ok);
    if (!ok) return;

    // Password prompt
    QString pwd = QInputDialog::getText(this, "Создать пользователя", "Password:", QLineEdit::Password, "", &ok);
    if (!ok || pwd.isEmpty()) return;

    // Create via AuthManager
    if (!AuthManager::instance().registerUser(login.toStdString(), role.toStdString(), pwd.toStdString())) {
        showError("Не удалось создать пользователя (возможно логин уже существует)");
        return;
    }
    Logger::log(m_adminId, "create_user", QString("login=%1 role=%2").arg(login).arg(role));
    loadUsers();
    QMessageBox::information(this,"OK","Пользователь создан");
}

void AdminWindow::onToggleActive() {
    auto sel = tblUsers->selectedItems();
    if (sel.isEmpty()) { showError("Выберите пользователя"); return; }
    int row = tblUsers->currentRow();
    int uid = tblUsers->item(row,0)->text().toInt();

    QSqlQuery q(Database::instance().get());
    // flip active
    q.prepare("UPDATE users SET active = NOT active WHERE id = ?");
    q.addBindValue(uid);
    if (!q.exec()) {
        showError("Не удалось обновить статус: " + q.lastError().text());
        return;
    }
    Logger::log(m_adminId, "toggle_active", QString("user_id=%1").arg(uid));
    loadUsers();
}

void AdminWindow::onEditUser() {
    auto sel = tblUsers->selectedItems();
    if (sel.isEmpty()) { showError("Выберите пользователя"); return; }
    int row = tblUsers->currentRow();
    int uid = tblUsers->item(row,0)->text().toInt();
    QString login = tblUsers->item(row,1)->text();
    QString full = tblUsers->item(row,2)->text();
    QString role = tblUsers->item(row,3)->text();

    bool ok;
    QString newFull = QInputDialog::getText(this, "Редактировать", "Full name:", QLineEdit::Normal, full, &ok);
    if (!ok) return;
    QString newRole = QInputDialog::getText(this, "Редактировать", "Role:", QLineEdit::Normal, role, &ok);
    if (!ok) return;

    QSqlQuery q(Database::instance().get());
    q.prepare("UPDATE users SET full_name = ?, role = ? WHERE id = ?");
    q.addBindValue(newFull);
    q.addBindValue(newRole);
    q.addBindValue(uid);
    if (!q.exec()) {
        showError("Не удалось изменить пользователя: " + q.lastError().text());
        return;
    }
    Logger::log(m_adminId, "edit_user", QString("user_id=%1").arg(uid));
    loadUsers();
    QMessageBox::information(this,"OK","Пользователь изменён");
}

void AdminWindow::onCreateDiscipline() {
    bool ok;
    QString name = QInputDialog::getText(this, "Создать направление", "Название:", QLineEdit::Normal, "", &ok);
    if (!ok || name.trimmed().isEmpty()) return;
    QString code = QInputDialog::getText(this, "Создать направление", "Код:", QLineEdit::Normal, "", &ok);
    if (!ok) return;

    QSqlQuery q(Database::instance().get());
    q.prepare("INSERT INTO disciplines (name, code) VALUES (?, ?)");
    q.addBindValue(name);
    q.addBindValue(code);
    if (!q.exec()) {
        showError("Не удалось создать направление: " + q.lastError().text());
        return;
    }
    Logger::log(m_adminId, "create_discipline", QString("name=%1 code=%2").arg(name).arg(code));
    QMessageBox::information(this,"OK","Направление создано");
}

void AdminWindow::onCreateAssignment() {
    bool ok;
    QString title = QInputDialog::getText(this, "Создать задание (админ)", "Заголовок:", QLineEdit::Normal, "", &ok);
    if (!ok || title.trimmed().isEmpty()) return;
    QString desc = QInputDialog::getMultiLineText(this, "Создать задание", "Описание:", &ok);
    if (!ok) return;

    QSqlQuery q(Database::instance().get());
    q.prepare("INSERT INTO assignments (title, description, discipline_id, created_by, due_date, created_at) VALUES (?, ?, NULL, NULL, NULL, NOW())");
    q.addBindValue(title);
    q.addBindValue(desc);
    if (!q.exec()) {
        showError("Не удалось создать задание: " + q.lastError().text());
        return;
    }
    Logger::log(m_adminId, "admin_create_assignment", QString("title=%1").arg(title));
    QMessageBox::information(this,"OK","Задание создано (без привязки к преподавателю)");
}

void AdminWindow::onRefresh() {
    loadUsers();
}

void AdminWindow::onDeleteUser() {
    auto sel = tblUsers->selectedItems();
    if (sel.isEmpty()) { showError("Выберите пользователя"); return; }
    int row = tblUsers->currentRow();
    int userId = tblUsers->item(row,0)->text().toInt();
    QString login = tblUsers->item(row,1)->text();

    if (QMessageBox::question(this, "Удалить пользователя", QString("Удалить пользователя %1 ?").arg(login),
                              QMessageBox::Yes|QMessageBox::No) != QMessageBox::Yes) return;

    QSqlQuery q(Database::instance().get());
    q.prepare("SELECT sp_delete_user(?, ?)");
    q.addBindValue(userId);
    q.addBindValue(m_adminId);
    if (!q.exec()) {
        showError("Не удалось удалить пользователя: " + q.lastError().text());
        return;
    }
    Logger::log(m_adminId, "delete_user", QString("user_id=%1").arg(userId));
    loadUsers();
    QMessageBox::information(this,"OK","Пользователь удалён");
}
