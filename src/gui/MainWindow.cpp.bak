#include "MainWindow.hpp"

#include "LoginWindow.hpp"
#include "TeacherWindow.hpp"
#include "StudentWindow.hpp"
#include "AdminWindow.hpp"

#include <QVBoxLayout>
#include <QHBoxLayout>
#include <QPushButton>
#include <QWidget>
#include <QLabel>
#include <QFile>
#include <QDebug>
#include <QApplication> // <- добавлено, чтобы qApp / QApplication::instance() были доступны

MainWindow::MainWindow(int userId, const QString &role, QWidget *parent)
    : QMainWindow(parent), m_userId(userId), m_role(role)
{
    setupUi();
}

void MainWindow::setupUi() {
    QWidget *central = new QWidget(this);
    setCentralWidget(central);
    auto v = new QVBoxLayout(central);

    // Top bar with Theme and Logout buttons
    auto topBar = new QHBoxLayout();
    topBar->addStretch();

    btnTheme = new QPushButton("Тема", this);
    btnTheme->setObjectName("themeButton");
    topBar->addWidget(btnTheme);

    btnLogout = new QPushButton("Выйти", this);
    btnLogout->setObjectName("logoutButton");
    topBar->addWidget(btnLogout);

    v->addLayout(topBar);

    // Content area
    if (m_role == "teacher") {
        TeacherWindow *tw = new TeacherWindow(m_userId, this);
        v->addWidget(tw, 1);
    } else if (m_role == "student") {
        StudentWindow *sw = new StudentWindow(m_userId, this);
        v->addWidget(sw, 1);
    } else if (m_role == "admin") {
        AdminWindow *aw = new AdminWindow(m_userId, this);
        v->addWidget(aw, 1);
    } else {
        QLabel *lbl = new QLabel(QString("Unknown role: %1").arg(m_role), this);
        v->addWidget(lbl);
    }

    connect(btnLogout, &QPushButton::clicked, this, &MainWindow::onLogout);
    connect(btnTheme, &QPushButton::clicked, this, &MainWindow::onToggleTheme);
}

void MainWindow::loadTheme(const QString &path) {
    QFile f(path);
    if (f.open(QFile::ReadOnly | QFile::Text)) {
        QString sheet = QString::fromUtf8(f.readAll());
        f.close();
        // безопасно получить указатель на QApplication
        if (QApplication *app = qobject_cast<QApplication*>(QApplication::instance())) {
            app->setStyleSheet(sheet);
        } else {
            qWarning() << "No QApplication instance available to set stylesheet.";
        }
    } else {
        qWarning() << "Cannot load theme:" << path;
    }
}

void MainWindow::onToggleTheme() {
    if (m_darkTheme) {
        loadTheme("style/light.qss");
    } else {
        loadTheme("style/dark.qss");
    }
    m_darkTheme = !m_darkTheme;
}

void MainWindow::onLogout() {
    LoginWindow *login = new LoginWindow();
    login->setAttribute(Qt::WA_DeleteOnClose);
    login->show();

    connect(login, &LoginWindow::loginSuccess, [login](int userId, const QString &role) {
        MainWindow *mw = new MainWindow(userId, role);
        mw->show();
        login->close();
    });

    this->close();
}
